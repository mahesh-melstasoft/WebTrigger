# Story 1.1: View Notification Settings

## Status
Draft

## Story
**As a** registered user  
**I want to** view my current notification settings for all channels  
**So that** I can understand which notifications are enabled

## Acceptance Criteria
1. Display enabled/disabled status for Email, WhatsApp, Telegram, SMS
2. Show configured recipient lists for each channel
3. Display notification triggers (success-only, failure-only, both)
4. Show plan limits for recipient counts
5. Display last notification sent timestamp
6. Indicate which channels are available for user's plan

## Tasks / Subtasks

- [ ] Create API endpoint for fetching notification settings (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Implement GET /api/notifications/settings route handler
  - [ ] Fetch NotificationSettings from database using Prisma
  - [ ] Include user subscription/plan data to determine limits
  - [ ] Return channel availability based on user's plan
  - [ ] Handle case where user has no settings (return defaults)
  - [ ] Add proper error handling and status codes
  - [ ] Add authentication middleware validation
  
- [ ] Create notification settings UI page (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create /settings/notifications page component
  - [ ] Implement settings fetch using SWR or React Query
  - [ ] Design channel status cards (Email, WhatsApp, Telegram, SMS)
  - [ ] Show enabled/disabled toggle state (read-only for now)
  - [ ] Display recipient lists for each channel
  - [ ] Show notification trigger preferences (success/failure/both)
  - [ ] Display plan limits with progress indicators
  - [ ] Add last notification sent timestamp display
  - [ ] Show locked state for unavailable channels (with upgrade CTA)
  - [ ] Add loading states and error handling
  - [ ] Make responsive for mobile devices

- [ ] Implement plan limit calculation logic (AC: 4, 6)
  - [ ] Create utility function to get limits by plan type
  - [ ] Calculate used vs available slots per channel
  - [ ] Map user role/subscription to plan tier
  - [ ] Return channel availability flags

- [ ] Add unit tests for API endpoint
  - [ ] Test successful settings fetch
  - [ ] Test user with no existing settings
  - [ ] Test plan limit calculations for all tiers
  - [ ] Test authentication failure
  - [ ] Test database error handling

- [ ] Add component tests for UI
  - [ ] Test settings display for all channels
  - [ ] Test loading state rendering
  - [ ] Test error state rendering
  - [ ] Test locked channel display for Free users
  - [ ] Test recipient list rendering
  - [ ] Test plan limit indicators

## Dev Notes

### Database Models
[Source: prisma/schema.prisma]

The `NotificationSettings` model contains all channel configurations:

```typescript
model NotificationSettings {
  id                    String   @id @default(cuid())
  userId                String   @unique
  
  // Email settings
  emailEnabled          Boolean  @default(false)
  emailRecipients       String[] @default([])
  emailOnSuccess        Boolean  @default(false)
  emailOnFailure        Boolean  @default(true)
  
  // WhatsApp settings
  whatsappEnabled       Boolean  @default(false)
  whatsappNumbers       String[] @default([])
  whatsappOnSuccess     Boolean  @default(false)
  whatsappOnFailure     Boolean  @default(true)
  
  // Telegram settings
  telegramEnabled       Boolean  @default(false)
  telegramChatIds       String[] @default([])
  telegramOnSuccess     Boolean  @default(false)
  telegramOnFailure     Boolean  @default(true)
  
  // SMS settings
  smsEnabled            Boolean  @default(false)
  smsNumbers            String[] @default([])
  smsOnSuccess          Boolean  @default(false)
  smsOnFailure          Boolean  @default(true)
  
  lastNotificationSent  DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
```

### Plan-Based Limits
[Source: NOTIFICATION_SYSTEM_IMPLEMENTATION.md]

Recipient limits by subscription plan:

```typescript
const NOTIFICATION_LIMITS = {
  FREE: {
    email: 1,        // User's own email only
    whatsapp: 0,     // Not available
    telegram: 0,     // Not available
    sms: 0           // Not available
  },
  PREMIUM: {         // Starter plan ($9/month)
    email: 3,
    whatsapp: 1,
    telegram: 1,
    sms: 1
  },
  PRO: {            // Pro plan ($29/month)
    email: 10,
    whatsapp: 5,
    telegram: 5,
    sms: 5
  },
  ADMIN: {          // Admin/Enterprise
    email: -1,      // -1 = unlimited
    whatsapp: -1,
    telegram: -1,
    sms: -1
  }
};
```

### API Specifications
[Source: Story requirements + architecture patterns]

**Endpoint**: `GET /api/notifications/settings`

**Request**: None (authenticated user from session)

**Response** (200 OK):
```typescript
{
  settings: {
    emailEnabled: boolean;
    emailRecipients: string[];
    emailOnSuccess: boolean;
    emailOnFailure: boolean;
    
    whatsappEnabled: boolean;
    whatsappNumbers: string[];
    whatsappOnSuccess: boolean;
    whatsappOnFailure: boolean;
    
    telegramEnabled: boolean;
    telegramChatIds: string[];
    telegramOnSuccess: boolean;
    telegramOnFailure: boolean;
    
    smsEnabled: boolean;
    smsNumbers: string[];
    smsOnSuccess: boolean;
    smsOnFailure: boolean;
    
    lastNotificationSent: string | null;
  },
  limits: {
    email: number;        // -1 for unlimited
    whatsapp: number;
    telegram: number;
    sms: number;
  },
  availability: {
    email: boolean;       // Always true
    whatsapp: boolean;    // Based on plan
    telegram: boolean;    // Based on plan
    sms: boolean;         // Based on plan
  },
  usage: {
    email: number;        // Current recipient count
    whatsapp: number;
    telegram: number;
    sms: number;
  }
}
```

**Error Responses**:
- 401: Not authenticated
- 500: Database error

### File Locations
[Source: docs/architecture/source-tree.md + Next.js conventions]

**Backend**:
- API Route: `src/app/api/notifications/settings/route.ts`
- Utility: `src/lib/notificationLimits.ts` (new file for limit calculations)

**Frontend**:
- Page: `src/app/settings/notifications/page.tsx` (new file)
- Components: `src/components/notifications/` (new folder)
  - `ChannelStatusCard.tsx` - Individual channel display
  - `RecipientList.tsx` - Show recipient emails/numbers
  - `PlanLimitIndicator.tsx` - Progress bar for limits
  - `UpgradePrompt.tsx` - CTA for locked features

### User Subscription Integration
[Source: Existing auth system]

User plan determined from `User.role` field:
- `ADMIN` → ADMIN limits
- `PREMIUM` → PRO limits  
- `STARTER` → PREMIUM limits
- Default → FREE limits

Fetch subscription data with user authentication:
```typescript
const user = await getCurrentUser(); // From auth helper
const plan = getUserPlanTier(user.role);
const limits = NOTIFICATION_LIMITS[plan];
```

### Testing

#### Testing Standards
[Source: docs/architecture/testing-strategy.md]

- **Test Location**: Co-located with source files using `.test.ts` or `.test.tsx` suffix
- **Frameworks**: Jest for unit tests, React Testing Library for components
- **Coverage**: Minimum 80% for new API endpoints, 70% for UI components
- **Patterns**: AAA pattern (Arrange, Act, Assert)

#### Specific Test Cases

**API Tests** (`src/app/api/notifications/settings/route.test.ts`):
1. Successfully fetches settings for authenticated user
2. Returns default settings when none exist
3. Correctly calculates limits based on user role
4. Returns 401 for unauthenticated requests
5. Handles database errors gracefully

**Component Tests** (`src/app/settings/notifications/page.test.tsx`):
1. Renders all 4 channel status cards
2. Shows loading skeleton during fetch
3. Displays error message on fetch failure
4. Shows correct enabled/disabled states
5. Displays recipient lists correctly
6. Shows plan limits with used/total counts
7. Locks unavailable channels for Free users
8. Displays last notification timestamp

### Technical Constraints
[Source: Next.js 15 + Prisma patterns]

- Use Next.js 15 App Router for API routes and pages
- Server Components by default, Client Components only when needed
- Prisma Client for database access (singleton pattern)
- SWR or React Query for client-side data fetching
- Tailwind CSS for styling (existing project standard)
- TypeScript strict mode enabled

### Security Considerations
[Source: Architecture security standards]

- Validate user authentication on API endpoint
- Only return settings for authenticated user (no userId in params)
- Sanitize recipient data before display
- Rate limit API endpoint (max 10 requests/minute per user)
- Log access to sensitive notification settings

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story draft | Scrum Master Bob |

## Dev Agent Record

This section will be populated during implementation.

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_To be filled by QA agent after implementation_
