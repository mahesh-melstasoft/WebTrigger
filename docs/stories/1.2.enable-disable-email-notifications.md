# Story 1.2: Enable/Disable Email Notifications

## Status
Draft

## Story
**As a** user  
**I want to** enable or disable email notifications  
**So that** I can control when I receive email alerts

## Acceptance Criteria
1. Toggle email notifications on/off
2. Select notification triggers (success, failure, or both)
3. See confirmation when settings are saved
4. Validate at least one channel is enabled (optional requirement)
5. Show current email addresses that will receive notifications
6. Update settings in real-time without page reload

## Tasks / Subtasks

- [ ] Update API endpoint to support settings updates (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Implement PUT /api/notifications/settings route handler
  - [ ] Accept email configuration in request body
  - [ ] Validate email settings (enabled, triggers, recipients)
  - [ ] Update NotificationSettings in database
  - [ ] Return updated settings in response
  - [ ] Add optimistic locking to prevent race conditions
  - [ ] Validate user authentication and authorization

- [ ] Create email notification toggle UI (AC: 1, 2)
  - [ ] Add toggle switch component for email enabled/disabled
  - [ ] Add trigger selection (checkboxes: success, failure, both)
  - [ ] Show current state from fetched settings
  - [ ] Handle toggle state changes
  - [ ] Trigger API update on change

- [ ] Implement settings save functionality (AC: 3, 6)
  - [ ] Use SWR mutate for optimistic updates
  - [ ] Show toast notification on successful save
  - [ ] Handle save errors with user-friendly messages
  - [ ] Update local state immediately (optimistic UI)
  - [ ] Revalidate data after mutation
  - [ ] Add debouncing for rapid changes

- [ ] Add recipient preview display (AC: 5)
  - [ ] Show list of email addresses that will receive notifications
  - [ ] Highlight primary user email
  - [ ] Display count (e.g., "2 recipients configured")
  - [ ] Link to recipient management (Story 1.3)

- [ ] Add validation logic (AC: 4)
  - [ ] Check if at least one channel remains enabled
  - [ ] Show warning if trying to disable last channel
  - [ ] Allow override with confirmation dialog
  - [ ] Validate trigger selection (at least one checked)

- [ ] Add unit tests for API endpoint
  - [ ] Test successful email settings update
  - [ ] Test trigger selection validation
  - [ ] Test concurrent update handling
  - [ ] Test unauthorized access
  - [ ] Test invalid data rejection

- [ ] Add component tests
  - [ ] Test toggle switch interaction
  - [ ] Test trigger checkbox selection
  - [ ] Test optimistic UI updates
  - [ ] Test error handling display
  - [ ] Test confirmation toast display

## Dev Notes

### API Specifications
[Source: Story requirements + REST patterns]

**Endpoint**: `PUT /api/notifications/settings`

**Request Body**:
```typescript
{
  emailEnabled: boolean;
  emailOnSuccess: boolean;
  emailOnFailure: boolean;
  // Other channels can be updated in same request
  // whatsappEnabled?: boolean;
  // telegramEnabled?: boolean;
  // etc.
}
```

**Response** (200 OK):
```typescript
{
  settings: NotificationSettings; // Updated full settings object
  message: "Settings updated successfully";
}
```

**Error Responses**:
- 400: Invalid input (no triggers selected, validation failed)
- 401: Not authenticated
- 409: Concurrent modification detected
- 500: Database error

### Database Update Logic
[Source: Prisma update patterns]

```typescript
// Use Prisma upsert to handle create or update
await prisma.notificationSettings.upsert({
  where: { userId: user.id },
  create: {
    userId: user.id,
    emailEnabled: data.emailEnabled,
    emailOnSuccess: data.emailOnSuccess,
    emailOnFailure: data.emailOnFailure,
    // ... other defaults
  },
  update: {
    emailEnabled: data.emailEnabled,
    emailOnSuccess: data.emailOnSuccess,
    emailOnFailure: data.emailOnFailure,
  },
});
```

### Component Structure
[Source: React patterns + existing UI components]

**File**: `src/components/notifications/EmailNotificationToggle.tsx`

```typescript
interface EmailNotificationToggleProps {
  settings: NotificationSettings;
  onUpdate: (updates: Partial<NotificationSettings>) => Promise<void>;
}

export function EmailNotificationToggle({ settings, onUpdate }: EmailNotificationToggleProps) {
  // Toggle switch for emailEnabled
  // Checkboxes for emailOnSuccess, emailOnFailure
  // Recipient preview
  // Save confirmation
}
```

### Optimistic UI Pattern
[Source: SWR best practices]

```typescript
import useSWR, { mutate } from 'swr';

const { data: settings } = useSWR('/api/notifications/settings');

const updateSettings = async (updates: Partial<NotificationSettings>) => {
  // Optimistic update
  mutate('/api/notifications/settings', 
    { ...settings, ...updates }, 
    false
  );
  
  try {
    const response = await fetch('/api/notifications/settings', {
      method: 'PUT',
      body: JSON.stringify(updates),
    });
    
    if (!response.ok) throw new Error('Update failed');
    
    // Revalidate
    mutate('/api/notifications/settings');
    toast.success('Settings saved!');
  } catch (error) {
    // Revert on error
    mutate('/api/notifications/settings');
    toast.error('Failed to save settings');
  }
};
```

### Validation Rules
[Source: Business requirements]

1. **Trigger Validation**: At least one trigger (success OR failure) must be selected when channel is enabled
2. **Channel Validation** (optional): At least one channel should remain enabled across all notification types
3. **Email Format**: Validate email addresses in recipients array (handled in Story 1.3)

### File Locations
[Source: Next.js App Router structure]

**Backend**:
- Update existing: `src/app/api/notifications/settings/route.ts` (add PUT handler)

**Frontend**:
- Component: `src/components/notifications/EmailNotificationToggle.tsx` (new)
- Update existing: `src/app/settings/notifications/page.tsx` (integrate toggle component)

### Testing

#### Testing Standards
[Source: docs/architecture/testing-strategy.md]

**API Tests** (`src/app/api/notifications/settings/route.test.ts`):
1. PUT request successfully updates email settings
2. Returns 400 when no triggers selected
3. Handles concurrent updates with optimistic locking
4. Returns 401 for unauthenticated users
5. Validates boolean fields

**Component Tests** (`src/components/notifications/EmailNotificationToggle.test.tsx`):
1. Renders toggle in correct initial state
2. Updates UI when toggle clicked
3. Shows trigger checkboxes when enabled
4. Displays success toast on save
5. Shows error message on API failure
6. Reverts optimistic update on error

### Dependencies
[Source: Story 1.1]

- Story 1.1 must be complete (GET endpoint and UI foundation)
- Extends existing settings page with update functionality

### Technical Constraints
[Source: Next.js + React patterns]

- Use React Server Components for page shell
- Client Component required for toggle interactions (use 'use client')
- Debounce rapid changes (300ms) to prevent API spam
- Toast notifications using existing toast library (react-hot-toast or sonner)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story draft | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
