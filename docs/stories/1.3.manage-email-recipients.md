# Story 1.3: Manage Email Recipients

## Status
Draft

## Story
**As a** user with paid plan  
**I want to** add additional email addresses to receive notifications  
**So that** my team members can also be alerted

## Acceptance Criteria
1. Add email addresses up to plan limit (Free: 1, Starter: 3, Pro: 10, Admin: unlimited)
2. Validate email format before adding
3. Remove email addresses from recipient list
4. Show remaining available slots
5. Display error when limit exceeded
6. Primary user email always included

## Tasks / Subtasks

- [ ] Extend PUT /api/notifications/settings to handle recipients (AC: 1, 2, 3, 5, 6)
  - [ ] Accept emailRecipients array in request body
  - [ ] Validate email format using regex
  - [ ] Enforce plan-based limits on recipient count
  - [ ] Ensure user's primary email is always in list
  - [ ] Return appropriate error codes for violations
  - [ ] Update database with new recipient list

- [ ] Create recipient management UI component (AC: 1, 2, 3, 4, 6)
  - [ ] Display current recipients as chips/badges
  - [ ] Add "Add Email" button with input field
  - [ ] Show remaining slots indicator (e.g., "2 of 3 used")
  - [ ] Highlight primary user email (non-removable)
  - [ ] Add remove button for each recipient (except primary)
  - [ ] Disable add button when limit reached
  - [ ] Show upgrade prompt for Free users

- [ ] Implement email validation logic (AC: 2)
  - [ ] Client-side validation using email regex
  - [ ] Server-side validation before database update
  - [ ] Show inline error for invalid emails
  - [ ] Prevent duplicate emails in list
  - [ ] Trim whitespace from input

- [ ] Add plan limit enforcement (AC: 1, 4, 5)
  - [ ] Fetch user's plan from subscription/role
  - [ ] Calculate available slots
  - [ ] Block additions beyond limit
  - [ ] Show error message with plan name
  - [ ] Display upgrade CTA when limit reached

- [ ] Add unit tests for API
  - [ ] Test adding valid email within limit
  - [ ] Test rejection when limit exceeded
  - [ ] Test invalid email format rejection
  - [ ] Test duplicate email prevention
  - [ ] Test primary email always included
  - [ ] Test plan limit calculations

- [ ] Add component tests
  - [ ] Test adding new recipient
  - [ ] Test removing recipient
  - [ ] Test email validation display
  - [ ] Test limit indicator updates
  - [ ] Test upgrade prompt for Free users
  - [ ] Test primary email cannot be removed

## Dev Notes

### Email Validation
[Source: RFC 5322 + practical patterns]

```typescript
const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

function isValidEmail(email: string): boolean {
  return EMAIL_REGEX.test(email.trim().toLowerCase());
}

function validateRecipients(
  emails: string[], 
  limit: number, 
  userEmail: string
): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  
  // Ensure primary email included
  if (!emails.includes(userEmail)) {
    emails.unshift(userEmail);
  }
  
  // Check limit
  if (limit !== -1 && emails.length > limit) {
    errors.push(`Maximum ${limit} recipients allowed for your plan`);
  }
  
  // Validate format
  emails.forEach(email => {
    if (!isValidEmail(email)) {
      errors.push(`Invalid email: ${email}`);
    }
  });
  
  // Check duplicates
  const unique = new Set(emails.map(e => e.toLowerCase()));
  if (unique.size !== emails.length) {
    errors.push('Duplicate emails not allowed');
  }
  
  return { valid: errors.length === 0, errors };
}
```

### Plan Limits Enforcement
[Source: NOTIFICATION_SYSTEM_IMPLEMENTATION.md]

```typescript
import { User } from '@prisma/client';

function getEmailRecipientLimit(user: User): number {
  switch(user.role) {
    case 'ADMIN':
      return -1; // unlimited
    case 'PREMIUM':
      return 10; // Pro plan
    case 'STARTER':
      return 3;  // Starter plan
    default:
      return 1;  // Free plan
  }
}

function canAddRecipient(
  currentCount: number, 
  limit: number
): boolean {
  return limit === -1 || currentCount < limit;
}
```

### API Update Extension
[Source: Story 1.2 PUT endpoint]

**Request Body** (extends Story 1.2):
```typescript
{
  emailEnabled?: boolean;
  emailOnSuccess?: boolean;
  emailOnFailure?: boolean;
  emailRecipients?: string[]; // NEW - array of email addresses
}
```

**Validation Steps**:
1. Fetch user's plan limit
2. Validate all emails in array
3. Ensure primary email present
4. Check array length against limit
5. Update database if all checks pass

**Error Response** (400 Bad Request):
```typescript
{
  error: "Recipient limit exceeded",
  details: "Your Starter plan allows up to 3 recipients. Upgrade to Pro for 10 recipients.",
  currentCount: 4,
  limit: 3
}
```

### Component Structure
[Source: React patterns + shadcn/ui components]

**File**: `src/components/notifications/EmailRecipientManager.tsx`

```typescript
interface EmailRecipientManagerProps {
  recipients: string[];
  userEmail: string;
  limit: number; // -1 for unlimited
  onChange: (recipients: string[]) => Promise<void>;
}

export function EmailRecipientManager({
  recipients,
  userEmail,
  limit,
  onChange
}: EmailRecipientManagerProps) {
  const [newEmail, setNewEmail] = useState('');
  const [error, setError] = useState('');
  
  const remainingSlots = limit === -1 ? null : limit - recipients.length;
  const canAdd = limit === -1 || recipients.length < limit;
  
  const handleAdd = async () => {
    if (!isValidEmail(newEmail)) {
      setError('Invalid email address');
      return;
    }
    
    if (recipients.includes(newEmail.toLowerCase())) {
      setError('Email already in list');
      return;
    }
    
    await onChange([...recipients, newEmail.toLowerCase()]);
    setNewEmail('');
    setError('');
  };
  
  const handleRemove = async (email: string) => {
    if (email === userEmail) return; // Cannot remove primary
    await onChange(recipients.filter(r => r !== email));
  };
  
  return (
    // UI implementation
  );
}
```

### UI Design Patterns
[Source: Existing shadcn/ui components]

- **Recipient Chips**: Use `Badge` component with X button
- **Add Input**: Use `Input` with `Button` inline
- **Limit Indicator**: Use `Progress` bar or text counter
- **Upgrade Prompt**: Use `Alert` component with link to billing
- **Primary Email**: Use different badge variant (outline vs default)

### File Locations

**Backend**:
- Update: `src/app/api/notifications/settings/route.ts` (extend PUT handler)
- Utility: `src/lib/notificationLimits.ts` (add validation functions)

**Frontend**:
- Component: `src/components/notifications/EmailRecipientManager.tsx` (new)
- Update: `src/app/settings/notifications/page.tsx` (integrate component)

### Testing

**API Tests**:
1. Successfully adds email within limit
2. Rejects invalid email formats
3. Prevents duplicate emails
4. Enforces plan limits (test all tiers)
5. Always includes primary email even if not in request
6. Returns appropriate error messages

**Component Tests**:
1. Displays all current recipients
2. Adds new valid email
3. Shows validation error for invalid email
4. Removes recipient when X clicked
5. Disables remove for primary email
6. Shows correct remaining slots count
7. Disables add button at limit
8. Shows upgrade prompt for Free users at limit

### Dependencies

- Story 1.1: Complete (GET endpoint)
- Story 1.2: Complete (PUT endpoint foundation)

### Security Considerations

- Sanitize email inputs to prevent XSS
- Validate on both client and server
- Rate limit recipient updates (max 10/hour per user)
- Log recipient changes for audit trail
- Prevent email harvesting (don't expose other users' recipients)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story draft | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
