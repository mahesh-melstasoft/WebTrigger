# Story 3.1: Auto-Send Notifications on Webhook Success

**Story ID**: 3.1  
**Epic**: Epic 3 - Webhook Integration  
**Priority**: CRITICAL  
**Story Points**: 5  
**Status**: To Do  

## User Story

**As a** system  
**I want to** automatically send notifications when webhooks succeed  
**So that** users are informed of successful executions  

## Acceptance Criteria

1. **Notification Trigger**: Notifications are sent immediately after webhook execution completes successfully (status 200-299)
2. **Settings Respect**: Only sends if user has enabled success notifications in their settings
3. **Multi-Channel Support**: Sends to all configured channels (email, WhatsApp, Telegram, SMS) that are enabled
4. **Execution Details**: Includes callback name, status code, and response time in notifications
5. **Template System**: Uses user's custom success template if configured, otherwise uses default success template
6. **Logging**: Logs notification delivery status for monitoring and debugging
7. **Non-Blocking**: Notification sending does not block or delay webhook execution
8. **Error Isolation**: Notification failures do not affect webhook success determination

## Technical Implementation

### Integration Point

**File to Modify**: `src/lib/actionExecutor.ts`

Add notification call after successful webhook execution:

```typescript
// After successful webhook execution
if (webhookResult.success) {
  // Existing success handling...
  
  // NEW: Trigger success notifications
  try {
    await notificationOrchestrator.sendNotifications({
      type: 'WEBHOOK_SUCCESS',
      callbackId: callback.id,
      callbackName: callback.name,
      statusCode: webhookResult.statusCode,
      responseTime: webhookResult.executionTime,
      userId: callback.userId,
      timestamp: new Date()
    });
  } catch (notificationError) {
    // Log but don't fail the webhook
    console.error('Notification failed for webhook success:', notificationError);
  }
}
```

### Notification Payload Structure

```typescript
interface WebhookSuccessPayload {
  type: 'WEBHOOK_SUCCESS';
  callbackId: string;
  callbackName: string;
  statusCode: number;        // e.g., 200, 201, 204
  responseTime: number;      // milliseconds
  userId: string;
  timestamp: Date;
}
```

### Template Variables

**Default Success Template**:
```
âœ… Webhook Success: {{callbackName}}

Your webhook executed successfully!
- Status: {{statusCode}}
- Response Time: {{responseTime}}ms
- Time: {{timestamp}}

Your integration is working correctly.
```

**Available Variables**:
- `{{callbackName}}` - Name of the webhook callback
- `{{statusCode}}` - HTTP status code returned
- `{{responseTime}}` - Execution time in milliseconds  
- `{{timestamp}}` - Formatted timestamp of execution

### Database Query for Settings

```typescript
const settings = await prisma.notificationSettings.findUnique({
  where: { userId: payload.userId },
  include: { emailTemplate: true }
});

if (settings?.webhookSuccessEnabled) {
  // Send notifications using configured channels
}
```

### Channels to Send

Based on user settings:
- **Email**: If `emailEnabled` and `emailRecipients` configured
- **WhatsApp**: If `whatsappEnabled` and `whatsappNumber` configured  
- **Telegram**: If `telegramEnabled` and `telegramChatId` configured
- **SMS**: If `smsEnabled` and `smsNumber` configured

### Error Handling

```typescript
try {
  await notificationOrchestrator.sendNotifications(payload);
} catch (error) {
  // Log error but don't re-throw - webhook should still succeed
  logger.error('Webhook success notification failed', {
    userId: payload.userId,
    callbackId: payload.callbackId,
    error: error.message
  });
}
```

## Testing Strategy

### Unit Tests

- Mock notification orchestrator calls
- Verify notification payload structure
- Test error handling doesn't affect webhook success

### Integration Tests

- Create test webhook that succeeds
- Verify notification is sent to all enabled channels
- Check notification content includes correct details
- Confirm webhook execution time isn't impacted

### Edge Cases

- User has no notification settings configured
- All channels disabled
- Template rendering fails
- External service (Twilio/Telegram) unavailable
- Rate limiting exceeded

## Definition of Done

- [ ] Integration added to `actionExecutor.ts`
- [ ] Success notifications sent for webhook executions
- [ ] All enabled channels receive notifications
- [ ] Template variables render correctly
- [ ] Error handling prevents webhook failures
- [ ] Performance impact < 100ms added to webhook execution
- [ ] Unit tests pass
- [ ] Integration tests pass

## Dependencies

- `src/lib/notificationService.ts` - Notification orchestrator
- `src/lib/actionExecutor.ts` - Webhook execution logic
- Database: `NotificationSettings` model
- Story 1.1: View notification settings (for user configuration)

## Notes

- **Async Processing**: Use `Promise.allSettled()` or fire-and-forget pattern
- **Rate Limiting**: Will be handled by Story 3.3
- **Template Fallback**: Default templates defined in notification service
- **Logging**: Use existing logging infrastructure
- **Performance**: Notifications should not add >100ms to webhook execution time
