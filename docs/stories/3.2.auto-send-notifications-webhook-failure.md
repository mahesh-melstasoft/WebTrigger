# Story 3.2: Auto-Send Notifications on Webhook Failure

**Story ID**: 3.2  
**Epic**: Epic 3 - Webhook Integration  
**Priority**: CRITICAL  
**Story Points**: 5  
**Status**: To Do  

## User Story

**As a** system  
**I want to** automatically send notifications when webhooks fail  
**So that** users can quickly respond to issues  

## Acceptance Criteria

1. **Notification Trigger**: Notifications are sent immediately after webhook execution fails (status >= 400 or network errors)
2. **Settings Respect**: Only sends if user has enabled failure notifications in their settings
3. **Multi-Channel Support**: Sends to all configured channels with higher priority for failures
4. **Error Details**: Includes status code, error message, and truncated response body
5. **Template System**: Uses failure-specific template with detailed error information
6. **Logging**: Logs notification delivery with error context for debugging
7. **Non-Blocking**: Notification sending does not block webhook error handling
8. **Error Isolation**: Notification failures do not mask original webhook errors

## Technical Implementation

### Integration Point

**File to Modify**: `src/lib/actionExecutor.ts`

Add notification call in webhook error handling:

```typescript
// In webhook error handling block
catch (error) {
  // Existing error handling...
  
  // NEW: Trigger failure notifications
  try {
    await notificationOrchestrator.sendNotifications({
      type: 'WEBHOOK_FAILURE',
      callbackId: callback.id,
      callbackName: callback.name,
      statusCode: error.status || error.statusCode || 0,
      error: error.message,
      responseBody: error.response?.body ? error.response.body.substring(0, 500) : null,
      userId: callback.userId,
      timestamp: new Date()
    });
  } catch (notificationError) {
    // Log but don't interfere with error handling
    console.error('Notification failed for webhook failure:', notificationError);
  }
  
  // Continue with existing error handling...
}
```

### Notification Payload Structure

```typescript
interface WebhookFailurePayload {
  type: 'WEBHOOK_FAILURE';
  callbackId: string;
  callbackName: string;
  statusCode: number;        // Error status code or 0 for network errors
  error: string;             // Error message
  responseBody?: string;     // Truncated response body (max 500 chars)
  userId: string;
  timestamp: Date;
}
```

### Template Variables

**Default Failure Template**:
```
❌ Webhook Failed: {{callbackName}}

Your webhook execution failed!
- Error: {{error}}
- Status Code: {{statusCode}}
- Time: {{timestamp}}

Response: {{responseBody}}

Please check your webhook configuration and target service.
```

**Available Variables**:
- `{{callbackName}}` - Name of the webhook callback
- `{{statusCode}}` - HTTP error status code (400, 500, etc.) or 0 for network errors
- `{{error}}` - Error message describing the failure
- `{{responseBody}}` - Truncated response body from failed request (max 500 chars)
- `{{timestamp}}` - Formatted timestamp of failure

### Database Query for Settings

```typescript
const settings = await prisma.notificationSettings.findUnique({
  where: { userId: payload.userId },
  include: { emailTemplate: true }
});

if (settings?.webhookFailureEnabled) {
  // Send failure notifications with higher priority
}
```

### Channels to Send

Same channels as success, but with higher priority:
- **Email**: If `emailEnabled` - mark as high priority
- **WhatsApp**: If `whatsappEnabled` - use urgent message format
- **Telegram**: If `telegramEnabled` - use error-specific formatting
- **SMS**: If `smsEnabled` - include "URGENT" prefix

### Error Handling

```typescript
try {
  await notificationOrchestrator.sendNotifications(payload);
} catch (error) {
  // Log error but don't interfere with webhook error processing
  logger.error('Webhook failure notification failed', {
    userId: payload.userId,
    callbackId: payload.callbackId,
    originalError: payload.error,
    notificationError: error.message
  });
}
```

## Error Types to Handle

1. **HTTP Errors**: 4xx, 5xx status codes
2. **Network Errors**: Connection timeouts, DNS failures
3. **SSL/TLS Errors**: Certificate issues
4. **Authentication Errors**: Invalid credentials
5. **Rate Limiting**: 429 Too Many Requests
6. **Server Errors**: 5xx responses with error details

## Testing Strategy

### Unit Tests

- Mock notification orchestrator calls
- Test various error types (400, 500, network failure)
- Verify error details are included in payload
- Test error handling doesn't affect webhook failure processing

### Integration Tests

- Create test webhook that fails (invalid URL, 500 error)
- Verify failure notification is sent to all enabled channels
- Check notification includes error details and truncated response
- Confirm webhook error handling still works correctly

### Edge Cases

- Very long error messages (>500 chars)
- Binary response bodies
- Circular reference errors
- External service completely down
- Rate limiting prevents failure notifications

## Definition of Done

- [ ] Integration added to `actionExecutor.ts` error handling
- [ ] Failure notifications sent for webhook errors
- [ ] Error details included in notifications
- [ ] All enabled channels receive failure alerts
- [ ] Template variables render error information correctly
- [ ] Error handling preserves original webhook error context
- [ ] Performance impact minimal on error processing
- [ ] Unit tests pass
- [ ] Integration tests pass

## Dependencies

- `src/lib/notificationService.ts` - Notification orchestrator
- `src/lib/actionExecutor.ts` - Webhook execution and error handling
- Database: `NotificationSettings` model
- Story 3.1: Webhook success notifications (shared infrastructure)

## Notes

- **Priority**: Failure notifications should have higher delivery priority
- **Truncation**: Limit response body to 500 characters to prevent spam
- **Template**: Use separate failure template with error-focused variables
- **Logging**: Include both original error and notification delivery status
- **Performance**: Keep notification overhead < 200ms even for failures
- **Testing**: Test with real error scenarios (invalid URLs, server errors)
